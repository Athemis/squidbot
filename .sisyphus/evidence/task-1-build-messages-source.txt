    async def build_messages(
        self,
        user_message: str,
        system_prompt: str,
    ) -> list[Message]:
        """
        Construct the full message list for an LLM call.

        Layout: [system_prompt + memory + skills]
                + [labelled_history] + [user_message]

        Args:
            user_message: The current user input.
            system_prompt: The base system prompt (AGENTS.md content).

        Returns:
            Ordered list of messages ready to send to the LLM.
        """
        history = await self._storage.load_history(last_n=self._history_context_messages)
        global_memory = await self._storage.load_global_memory()

        # Label each history message with channel/sender context
        labelled_history = [self._label_message(msg) for msg in history]

        # Build system prompt with global memory appended
        full_system = system_prompt
        if global_memory.strip():
            full_system += f"\n\n## Your Memory\n\n{global_memory}"

        # Inject skills: XML index + full bodies of always-skills
        if self._skills is not None:
            from squidbot.core.skills import build_skills_xml  # noqa: PLC0415

            skill_list = self._skills.list_skills()
            full_system += f"\n\n{build_skills_xml(skill_list)}"
            for skill in skill_list:
                if skill.always and skill.available:
                    body = self._skills.load_skill_body(skill.name)
                    full_system += f"\n\n{body}"

        messages: list[Message] = [
            Message(role="system", content=full_system),
            *labelled_history,
            Message(role="user", content=user_message),
        ]
        return messages

